\documentclass{labs}

\begin{document}
	\maketitlepage[2]	
	{Чисельно-аналітичне моделювання}
	{Визначення оптимальної стратегії лікування пневмонії на основі результатів клінічних досліджень}
	{Соловйов~C.~О.}
	{		&{Сахаров~С.~Ю.,}\\
			&{Вергун~К.~В.,}\\
			&{Борисенко~П.~Б.,}\\
			&{Федченко~О.~А.,}\\
			&{Дутчак~І.~О.}\\
	}
	{КМ-41м}
	
\tableofcontents
	
\intro
% Сергій: 
% Наповнити:
% 1. Факт існування проблеми неоптимальних стратегій лікування вцілому та пневмонії зокрема.
Під час лікування будь-якої хвороби, безумовно, основною задачею є вилікувати хворого. 
Проте немає єдиного способу вирішити цю задачу, існує деяка множина таких стратегій, покликаних вилікувати пацієнта. 
Усі вони можуть характеризуватись такими числовими показниками, як ціною лікування, часом лікування, безпечністю лікування тощо. 
Тому разом із задачею вилікувати хворого постає побічна задача: вилікувати хворого так, щоб певна характеристика процедури лікування задовольняла деякі наперед задані умови. 

% 2. Посилання на схожу ситуацію із раком.
Наприклад, досить актуальною, безумовно, є задача організації такого стримування пізніх стадій раку, щоб хворий прожив якомога довше \cite{canser-NN}. В цій та подібних задачах до уваги беруться параметри, що характеризують стан хворого, а також параметри, що характеризують терапію.
   
% 3. Породження надії знайти оптимальну стратегію за допомогою математики
Із розвитком інформаційних технологій та із ростом потужностей обчислювальної техніки дана задача видається такою, яку можна вирішити. 
В даній роботі будуть розглянуті існуючі математичні моделі, які вирішують задачі такого класу.
% 4. Навіювання песимістичного настрою у зв'язку із неможливістю отримання необхідної вибірки, бо порушується етичні принципи.
Разом з тим, визначення параметрів цих моделей потребує відповідної вибірки, яка не може бути отримана безпосередньо з цією метою, адже це порушує морально-етичні принципи. 
% 5. Відновлення надії у зв'язку із фактом наявності записів клінічних досліджень. 
Проте, на щастя, така вибірка може бути отримана із записів про протікання хвороби та лікування, зроблених в межах клінічних досліджень.

Дана робота присвячена пошуку найшвидшої стратегії лікування пневмонії, тобто такої стратегії, за якою пацієнт одужує за мінімальну кількість ліжко-днів. 

% Паша: 
% 1. Прочитати, профільтрувати на адекватність


\chapter{Постановка задачі}
% Паша:
% 1. Написати, що ми хочемо та маємо зробити:
Завданням даної практичної роботи є визначення оптимальної стратегії лікування пневмонії на основі результатів клінічних доліджень.

Стратегія лікування включає в себе комплекс антибактеріальних та противірусних препаратів, що застосовуються для лікування пацієнта, з урахуванням різної тривалості застосування кожного окремого препарата ат всього комплексу вцілому.

Оптимальною вважається така стратегія лікування, що мінімізовує кількість ліжко-днів, що пацієнь буде хнаходитися у лікарні.

В якості початкових даних використовуються результати клінічних досліджень ефективності окремих препаратів та їх груп, а також спостережень за існуючими клінічними випадками захворювань на пневмонію.  

\chapter{Огляд методів вирішення задач даного класу}
% Сергій: 
% 1. Знайти 3-4 методи (із джерелами) вирішення класу задач
% 2. Описати їх на концептуальному рівні у відповідних секціях розділу
	
	\section{Баєсові мережі}
		
		Баєсова мережа\cite{BayesianNetworks} --- це графічна ймовірнісна модель, що являє собою множину змінних  і ймовірнісних залежностей між ними. 
		В основі цієї моделі лежить теорема Баєса, що визначає співвідношення поточної ймовірності до попередньої.
		
		Баєсова мережа представляється у вигляді орієнтованого ациклічного графа (рис.~\ref{fig:BayesianNetwork}), вершини якого це змінні будь-якого характеру, а ребра задають умовну залежність між змінними.
		\begin{figure}[!htp]%
			\centering
			\includegraphics[scale = 0.6]{PNG/BayesianNetwork.png}%
			\caption{Орієнтований ациклічний граф Баєсової мережі}%
			\label{fig:BayesianNetwork}%
		\end{figure}
		
		Якщо ребро виходить з вершини $A$ у вершину $B$, то $A$ називають предком $B$, а $B$ називають нащадком $A$. 
		Множину вершин-предків вершини $X_{i}$ позначимо $parents(X_{i})$.
		Тоді спільний розподіл значень у вершинах можна розписати як:
		\begin{equation}
		\nonumber
		p(X_{1},\ldots,X_{n}) = \prod_{i=1}^{n}{p(X_{i}|parents(X_{i}))}
		\end{equation}
		
		Конкретні числові значення ймовірностей знаходяться в процесі навчання Баєсової мережі.
		
	\section{Багатофакторна регресія}
	
	Поставлену задачу можна представити у вигляді багатофакторної регресійної моделі\cite{Regression} (нелінійної в загальному випадку):
		
		\begin{equation}
		\nonumber
			y = f(\bold{x}, \bold{w}),
		\end{equation}
		де $y$ --- шукана характеристики;
			$x$ --- вектор незалежних змінних;
			$w$ --- вектор параметрів.
			У нашому випадку, $x$ --- параметри хворого та лікування, $y$ --- кількість ліжко-днів витрачених на лікування.
			
			Параметри $w$ визначаються при мінімізації функції помилки:
			\begin{equation}
				\nonumber
				F(\bold{x}, \bold{w}, \bold{y}) = \sum_{i=1}^{n}{(y_{i} - f_{i}(\bold{x}, \bold{w}))^{2}},
			\end{equation}
			де $n$ --- об'єм вибірки.
			
			А ця задача зводиться до вирішення однорідної системи рівнянь:
			\begin{equation}
				\left\{
				\begin{aligned}
					& \frac{\partial{F}}{\partial{w_{1}}} = 0, \\
					& \ldots \\
					& \frac{\partial{F}}{\partial{w_{m}}} = 0, \\
				\end{aligned}
				\right.
			\end{equation}
			де $m$ --- кількість параметрів.
			
			Проблема використання багатофакторної регресії полягає у необхідності визначення функції $f = f(\bold{x}, \bold{w})$.
			
	\section{Нейронні мережі}
	
	Використання нейронних мереж\cite{NeuralNetwork} для вирішення поставленої задачі дещо схоже на використання багатофакторної регресії
	\begin{equation}
		\nonumber
		y = f(\bold{x}, \bold{W}),
	\end{equation}
	але тут вектор параметрів $W$ має дещо інший характер, а функція $y = f(\bold{x}, \bold{W})$ являє собою суперпозицію функцій активації нейронів, вона визначається в процесі навчання мережі.
	
	В процесі навчання відбувається мінімізація функції помилки
	\begin{equation}
		\nonumber
		F(\bold{x}, \bold{W}, \bold{y}) = \sum_{i=1}^{n}{(y_{i} - f_{i}(\bold{x}, \bold{W}))^{2}}
	\end{equation}
	за рахунок зміни вагів $W$ за алгоритмом зворотного поширення помилки.

\chapter{Пристосування нейронної мережі до вирішення поставленої задачі}

	\section{Архітектура мережі}
		Нейронна мережа приймає на вхід параметри пацієнта та набору препаратів, на виході видає кількість ліжко-днів $N$, необхідних для лікування пацієнта із заданими параметрами при заданій стратегії лікування (рис.~\ref{fig:NN-concept}).
	
	\begin{figure}[htp!]%
	\includegraphics[scale=1]{PNG/NN-Process.png}%
	\caption{Концептуальна схема процесу роботи нейронної мережі}%
	\label{fig:NN-concept}%
	\end{figure}
	% Паша, Костя: 
	% 1. Структурно-числова інфа про нашу мережу
		Для розрахунків було використано двошарову нейронну мережу з прямим зв'язком (рис.~\ref{fig:NN-plot}) та 150 нейронами у прихованому шарі. В якості функцій активації для прихованого шару було обрано сигмоїду, а для вхідного шару --- лінійну функцію. Така нейронна мережа може бути натренованою на данних довільної розмірності за умови наявності достатньої кількості консистентних даних та нейрноів у прихованому шарі.
	
	\begin{figure}[htp!]%
	\includegraphics[scale=1]{PNG/NN-plot.png}%
	\caption{Cхема внутрішнього представлення нейронної мережі}%
	\label{fig:NN-plot}%
	\end{figure} 
		
		Для тренування мережі використовувався метод зворотнього зв'язку з алгоритмом Левенберга-Марквардта.

		Для визначення оптимальної стратегії лікування вирішувалася оптимізаційна задача підбору вектора керування, що мінімізовував кількість ліжко-днів для фіксованих параметрів пацієнта.
	
	\section{Вихідні дані}
	Вихідні дані задачі було розділено на дві групи: 
	\begin{enumerate}
		\item параметри пацієнта;
		\item параметир керування.
	\end{enumerate}

	% Сергій:
	% 1. Описати наявні дані
	До параметрів пацієнта належать:
	\begin{itemize}
		\item вікова група;
		\item наявність супутніх захворювань;
		\item температура тіла;
		\item характер мокроти;
		\item локалізація НП;
		\item характер поширеності процесу;
		\item характер рентгенодинаміки;
		\item рівень лейкоцитів;
		\item лейкоцитарні зміни;
		\item рівень ШОЕ;
		\item загальний стан;
		\item вірусний агент;
		\item бактеріальний агент.
	\end{itemize}
	
	Параметрами керування є:
	\begin{itemize}
		\item антибактеріальний препарат №1;
		\item тривалість терапії АБ препарату №1;
		\item антибактеріальний препарат №2;
		\item тривалість терапії АБ препарату №2;
		\item антибактеріальний препарат №3;
		\item тривалість терапії АБ препарату №3;
		\item антибактеріальний препарат №4;
		\item тривалість терапії АБ препарату №4;
		\item противірусний препарат X;
		\item тривалість терапії противірусного препарату X;
		\item тривалість AБ терапії;
		\item продовження лікування.
	\end{itemize}
	%
	% Паша, Костя: 
	% 1. Описати комбінацію даних із мержею (мережами)
	Параметри пацієнта вважаються фіксованими, тобто такими, що не залежать від обраної стратегії лікування. 
	Параметри керування представляють собою ті параметри, що визначають стратегію лікування та можуть варіюватися.

	На першому кроці ці дані використовувалися для тренування нейронної мережі, що мала визначити тривалість лікування, на основі даних клінічних досліджень. 
	На другому кроці за введеними параметрами пацієнта система підбирала оптимальну стратегію лікування.
	
	\section{Процес навчання}
	% Паша, Костя:
	% 1. Графіки навчань
	Початково планувалося використати одну мережу для виконання розрахунків, однак через неоднорідність даних було вирішено розбити початкову нейронну мережу, на кілька менших нейронних мереж, що відповідають окремим групам антибактеріальних препаратів.

	Графіки навчання для цих мереж представлено на рис.~\ref{NN-regression-1}-\ref{NN-regression-5}.

	\begin{figure}[htp!]%
	\includegraphics[scale=1]{PNG/NN-regression-1.png}%
	\caption{Результати роботи нейронної мережі 1}%
	\label{fig:NN-regression-1}%
	\end{figure}
	
	\begin{figure}[htp!]%
	\includegraphics[scale=1]{PNG/NN-regression-2.png}%
	\caption{Результати роботи нейронної мережі 2}%
	\label{fig:NN-regression-2}%
	\end{figure}

	\begin{figure}[htp!]%
	\includegraphics[scale=1]{PNG/NN-regression-3.png}%
	\caption{Результати роботи нейронної мережі 3}%
	\label{fig:NN-regression-3}%
	\end{figure}

	\begin{figure}[htp!]%
	\includegraphics[scale=1]{PNG/NN-regression-4.png}%
	\caption{Результати роботи нейронної мережі 4}%
	\label{fig:NN-regression-4}%
	\end{figure}

	\begin{figure}[htp!]%
	\includegraphics[scale=1]{PNG/NN-regression-5.png}%
	\caption{Результати роботи нейронної мережі 5}%
	\label{fig:NN-regression-5}%
	\end{figure}

	% 2. Критерії закінчення навчання
	В якості критерію зупинки використовувалося середнє значення різниці квадратів виходу мережі та реальних значень по всій навчальній вибірці. 

	В якості іншого критерію використовувалися результати роботи мережі на валідаційній вибірці, що була отримана з початкових даних шляхом випадкового відбору 15-30~\% випадків.

	% 3. Критерії вибору найкращої мережі
	Для підбору найкращої мережі (а відтак і стратегії навчання) використовувалися результати оптимізації: мережа, що давала мінімальний результат, та відповідна їй стратегія лікування вважалися найкращими.
	
	\section{Отримані результати}
	% Паша, Костя:
	% 1. Адекватність.
	Для тестування результатів роботи нейронних мереж використовувалася тестова вибірка, що складалася з 15-30~\% випадково вибраних вихідних даних, порівну для кожної побудованої мережі.
	Як видно з графіків (рис.~\ref{NN-regression-1}-\ref{NN-regression-5}), результати роботи нейронних мереж досить точно відповідають реальним даним.

	Отримані результати дозволяють говорити про адекватність обраної математичної моделі.
	% 2. Вказати можливі причини таких хороших (поганих) результатів 
	Варто, однак, відмітити, що вцілому результати роботи системи прогнозування все ще залишаються недостатньо точними. оскільки на кроці оптимізації і пошуку оптимальної стратегії лікування важко врахувати усі обмеження, що накладаються на параметри керування.

	Головним чином, це стосується застосування різних комбінацій антибактеріальних препаратів у комплексі, а також необхідністю враховувати цілочисленість значень деяуих змінних.

	У якості можливих шляхів покращення отриманих результатів, більшість яких концентрується навколо пошуку оптимальної стратегії лікування, варто відзначити застосування методів цілочисельного програмування та нейронних мереж, що, однак, вимагає додаткових досліджень. 

\conclusion
% Сергій:
% 1. Вказати, що були розгянуті математичні методи вирішення задачі
В даній практичній роботі було розглянуто математичні моделі, що вирішують задачу пошуку оптимальної стратегії лікування пневмонії на основі результатів клінічних досліджень.

З-поміж розглянутих методів було обрано метод нейронних мереж для вирішення поставленої задачі.
%
% Ігор:
% 1. Прочитати вступ, постановку задачі та отримані результати.
% 2. Прокоментувати результати
% 3. Шляхи покращення
\begin{thebibliography}

\bibitem{canser-NN} 
Polak S. Artificial neural networks based modeling for pharmacoeconomics application / S.~Polak, A.~Skowron, J.~Brandys, A.~Mendyk // Applied Mathematics and Computation. --- 2008. No. 203. --- P. 482--492.
		
\bibitem{BayesianNetworks} 
Jensen~F.~V. Bayesian Networks and Decision Graphs / F.~V.~Jensen // Statistics for engineering and information science. --- Springer. --- New York. --- 2001. --- p. 268

\bibitem{Regression}
Lindley~D.~V. Regression and correlation analysis /D.~V.~Lindley // New Palgrave: A Dictionary of Economics, v. 4, pp. 120–23.

\bibitem{NeuralNetwork}	
Хайкин С. Нейронные сети: полный курс : пер. с англ. / C.~Хайкин. --- 2-е изд. ---  М. : Издательский дом \invcommas{Вильямс}. --- 2006. --- 1104 с.

\end{thebibliography}
	
\append{Вихідні коди} 
% Паша, Костя: 
% 1. Вставити код проги

	\begin{lstlisting}[language=Matlab, basicstyle=\tiny, breaklines=true]
% Функція пошуку оптимальної стратегії лікування
function [y u] = finder(nets, x, k)
    u = zeros(length(nets),k);
    y = zeros(length(nets),1);
    for i = 1:length(nets)
        fprintf('Processing net %d...\n', i);
        net = nets{i};
        f = @(u) abs(net([x u]'));
        [u(i,:), y(i)] = fmincon(f,zeros(1,k),[],[],[],[],...
        [0  0   0  0   0  0   0  0   0 0   0],...
        [20 Inf 20 Inf 20 Inf 20 Inf 1 Inf Inf]);
        fprintf('End processing net %d.\n', i);
    end
    [y,I] = min(y);
    u = u(I,:);
end

%% TEST FRAMEWORK
clear; close all; clc;
% load predefined NN
data = load('5nets.mat');
nets = {data.net1, data.net2, data.net3, data.net4, data.net5};
% sizes of IO vectors
x_len = 31;
u_len = length(data.x1(1,:) - x_len);
% test case
x_practical = data.x1(1,1:x_len);
u_practical = data.x1(1,x_len+1:end-1);
y_practical = data.x1(1,end);
[y u] = finder(nets, x_practical, u_len);
% results
fprintf('Number of bed/days: %d\n', y);
fprintf('Control vector: \n');
for i = 1:u_len
    fprintf('%d ', u(i));
end
% error
fprintf('\n\nAbsolute error on y: %d\n', abs(y - y_practical));
fprintf('Relative error on y: %d\n', abs(y - y_practical) / y_practical);
	\end{lstlisting}

\end{document}

